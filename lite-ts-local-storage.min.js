!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var r in o)("object"==typeof exports?exports:e)[r]=o[r]}}(self,(()=>(()=>{"use strict";var e=[function(e,t,o){var r=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),i=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||r(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),t.uowDbOption=t.modelDbOption=void 0,i(o(1),t);var n=o(8);Object.defineProperty(t,"modelDbOption",{enumerable:!0,get:function(){return n.modelDbOption}}),Object.defineProperty(t,"uowDbOption",{enumerable:!0,get:function(){return n.uowDbOption}})},(e,t,o)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.LocalStorageDbFactory=void 0;const r=o(2),i=o(8),n=o(10);class s extends r.DbFactoryBase{constructor(e){super(),this.m_LocalStorage=e}db(...e){const t=new i.DbRepository(this.uow(),this.m_LocalStorage);return e.forEach((e=>{e(t)})),t}uow(){return new n.UnitOfWork(this.m_LocalStorage)}}t.LocalStorageDbFactory=s},function(e,t,o){var r=this&&this.__createBinding||(Object.create?function(e,t,o,r){void 0===r&&(r=o);var i=Object.getOwnPropertyDescriptor(t,o);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[o]}}),Object.defineProperty(e,r,i)}:function(e,t,o,r){void 0===r&&(r=o),e[r]=t[o]}),i=this&&this.__exportStar||function(e,t){for(var o in e)"default"===o||Object.prototype.hasOwnProperty.call(t,o)||r(t,e,o)};Object.defineProperty(t,"__esModule",{value:!0}),i(o(3),t),i(o(4),t),i(o(5),t),i(o(6),t),i(o(7),t)},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.DbFactoryBase=t.DbModel=void 0;t.DbModel=class{};t.DbFactoryBase=class{}},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,o){var r=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(i,n){function s(e){try{a(r.next(e))}catch(e){n(e)}}function c(e){try{a(r.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbRepository=t.uowDbOption=t.modelDbOption=void 0;const i=o(9);t.modelDbOption=function(e){return t=>{t.model="string"==typeof e?e:e.ctor}},t.uowDbOption=function(e){return t=>{t.uow=e}};t.DbRepository=class{set uow(e){this.m_IsTx=!0,this.m_Uow=e}set model(e){this.m_Model=e}constructor(e,t){this.m_Uow=e,this.m_LocalStorage=t}add(e){return r(this,void 0,void 0,(function*(){this.m_Uow.registerAdd(this.m_Model,e),this.m_IsTx||(yield this.m_Uow.commit())}))}query(){return new i.DbQuery(this.m_Model,this.m_LocalStorage)}remove(e){return r(this,void 0,void 0,(function*(){this.m_Uow.registerRemove(this.m_Model,e),this.m_IsTx||(yield this.m_Uow.commit())}))}save(e){return r(this,void 0,void 0,(function*(){this.m_Uow.registerSave(this.m_Model,e),this.m_IsTx||(yield this.m_Uow.commit())}))}}},function(e,t){var o=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(i,n){function s(e){try{a(r.next(e))}catch(e){n(e)}}function c(e){try{a(r.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.DbQuery=void 0;t.DbQuery=class{constructor(e,t){this.m_Model=e,this.m_LocalStorage=t}count(e){return o(this,void 0,void 0,(function*(){return(yield this.toArray({where:e})).length}))}toArray(e){return o(this,void 0,void 0,(function*(){const t=this.m_LocalStorage.getItem(this.m_Model);let o=t?JSON.parse(t):[];return(null==e?void 0:e.where)&&(o=o.filter(e.where)),o}))}}},function(e,t){var o=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))((function(i,n){function s(e){try{a(r.next(e))}catch(e){n(e)}}function c(e){try{a(r.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}a((r=r.apply(e,t||[])).next())}))};Object.defineProperty(t,"__esModule",{value:!0}),t.UnitOfWork=void 0;t.UnitOfWork=class{constructor(e){this.m_LocalStorage=e,this.m_AfterActions=[],this.m_Operation={}}commit(){return o(this,void 0,void 0,(function*(){Object.entries(this.m_Operation).forEach((([e,t])=>{const o=this.m_LocalStorage.getItem(e),r=(o?JSON.parse(o):[]).reduce(((e,t)=>(e[t.id]=t,e)),{});t.forEach((e=>{e(r)})),this.m_LocalStorage.setItem(e,JSON.stringify(Object.values(r)))}));for(const e of this.m_AfterActions)yield e();this.m_AfterActions=[]}))}registerAdd(e,t){this.registerSave(e,t)}registerAfter(e){this.m_AfterActions.push(e)}registerRemove(e,t){var o,r;null!==(o=(r=this.m_Operation)[e])&&void 0!==o||(r[e]=[]),this.m_Operation[e].push((e=>{delete e[t.id]}))}registerSave(e,t){var o,r;null!==(o=(r=this.m_Operation)[e])&&void 0!==o||(r[e]=[]),this.m_Operation[e].push((e=>{e[t.id]=t}))}}}],t={};var o=function o(r){var i=t[r];if(void 0!==i)return i.exports;var n=t[r]={exports:{}};return e[r].call(n.exports,n,n.exports,o),n.exports}(0);return o})()));